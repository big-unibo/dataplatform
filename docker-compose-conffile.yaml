version: "3.9"
services:
  namenode1:
    image: apache/hadoop:${HADOOPVERSION}
    ports:
      - ${NAMENODEPORT}:${NAMENODEPORT}
    volumes:
       - hadoop_namenode1:${NAMEDIR}
      #- hadoop_config:${HADOOPCONFDIR}
    env_file:
      - ./dataplatform/conf_files/namenode1.conf
      - ./dataplatform/conf_files/.env
    environment:
      - HADOOP_HOME=/opt/hadoop/
    command:
      - /bin/bash
      - -c
      - |
       sleep 20
        echo sudo mkdir -p ${NAMEDIR}
        sudo mkdir -p ${NAMEDIR}
        echo sudo chown hadoop ${NAMEDIR}
        sudo chown hadoop ${NAMEDIR}
        if [ ! -d ${NAMEDIR} ]; then
          echo "Namenode name directory not found: ${NAMEDIR}"
          exit 2
        fi

        if [ -z "${CLUSTERNAME}" ]; then
          echo "Cluster name not specified"
          export CLUSTERNAME=test
        fi

        if [ "`ls -A ${NAMEDIR}`" == "" ]; then
          echo "Formatting namenode name directory: ${NAMEDIR}"
          /opt/hadoop/bin/hdfs --config /opt/hadoop/etc/hadoop namenode -format ${CLUSTERNAME}
        else
          echo "${NAMEDIR} exists!"
        fi
        hdfs --config /opt/hadoop/etc/hadoop namenode
    deploy:
      placement:
        constraints:
          - node.role == manager
    networks:
      - hadoop-network 

  activator:
    image: apache/hadoop:${HADOOPVERSION}
    env_file:
      - ./dataplatform/conf_files/hadoop.conf
      - ./dataplatform/conf_files/.env
    command:
      - /bin/bash
      - -c
      - |
       sleep 60
        hdfs haadmin -transitionToActive nn1 

  namenode2:
    image: apache/hadoop:${HADOOPVERSION}
    ports:
      - ${NAMENODE2PORT}:${NAMENODE2PORT}
    volumes:
      - hadoop_namenode2:${NAMEDIR}
      #- hadoop_config:${HADOOPCONFDIR}
    env_file:
      - ./dataplatform/conf_files/namenode2.conf
      - ./dataplatform/conf_files/.env
    environment:
      - HADOOP_HOME=/opt/hadoop/
    command:
      - /bin/bash
      - -c
      - |
        sleep 40
        mkdir -p ${NAMEDIR}
        sudo chown hadoop ${NAMEDIR}
        if [ "`ls -A ${NAMEDIR}`" == "" ]; then
          echo "Bootstrappppppping namenode2"
          /opt/hadoop/bin/hdfs namenode -bootstrapStandby
        fi
        hdfs --config /opt/hadoop/etc/hadoop namenode
    deploy:
      placement:
        constraints:
          - node.role == manager
    networks:
      - hadoop-network
       
  datanode:
    image: apache/hadoop:${HADOOPVERSION}
    volumes:
      - hadoop_datanode:${DATADIR}
      #- hadoop_config:${HADOOPCONFDIR}
    env_file:
      - ./dataplatform/conf_files/hadoop.conf
      - ./dataplatform/conf_files/.env
    command:
      - /bin/bash
      - -c
      - |
        sleep 60
        mkdir -p ${DATADIR}
        sudo chown hadoop ${DATADIR}
        if [ ! -d ${DATADIR} ]; then
          echo "Datanode data directory not found: ${DATADIR}"
          exit 2
        fi
        hdfs --config /opt/hadoop/etc/hadoop datanode
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
    networks:
      - hadoop-network
      
  journal1:
    image: apache/hadoop:${HADOOPVERSION}
    env_file:
      - ./dataplatform/conf_files/hadoop.conf
      - ./dataplatform/conf_files/.env
    volumes:
      - hadoop_journal1:${JOURNALDIR}
      #- hadoop_config:${HADOOPCONFDIR}
    command: 
      - /bin/bash
      - -c
      - |
        mkdir -p ${JOURNALDIR}
        sudo chown hadoop ${JOURNALDIR}
        hdfs journalnode
    deploy:
      placement:
        constraints:
          - node.role == manager
    networks:
      - hadoop-network 

  journal2:
    image: apache/hadoop:${HADOOPVERSION}
    env_file:
      - ./dataplatform/conf_files/hadoop.conf
      - ./dataplatform/conf_files/.env
    volumes:
      - hadoop_journal2:${JOURNALDIR}
      #- hadoop_config:${HADOOPCONFDIR}
    command:       
      - /bin/bash
      - -c
      - |
        mkdir -p ${JOURNALDIR}
        sudo chown hadoop ${JOURNALDIR}
        hdfs journalnode
    deploy:
      placement:
        constraints:
          - node.role == manager
    networks:
      - hadoop-network 

  journal3:
    image: apache/hadoop:${HADOOPVERSION}
    env_file:
      - ./dataplatform/conf_files/hadoop.conf
      - ./dataplatform/conf_files/.env
    volumes:
      - hadoop_journal3:${JOURNALDIR}
    #  - hadoop_config:${HADOOPCONFDIR}
    command:
      - /bin/bash
      - -c
      - |
        mkdir -p ${JOURNALDIR}
        sudo chown hadoop ${JOURNALDIR}
        hdfs journalnode
    deploy:
      placement:
        constraints:
          - node.role == manager
    networks:
      - hadoop-network 

  portainer:
    init: true
    image: portainer/portainer-ce:latest
    ports:
      -  9443:9443
    volumes:
      -  /var/run/docker.sock:/var/run/docker.sock
      - ./portainer_data:/data
    deploy:
      placement:
        constraints:
         - node.role == manager 
    networks:
      - hadoop-network 

volumes:
  hadoop_namenode1:
  hadoop_namenode2:
  hadoop_datanode:
  hadoop_journal1:
  hadoop_journal2:
  hadoop_journal3:
#  hadoop_historyserver:

networks:
  hadoop-network:
    driver: overlay