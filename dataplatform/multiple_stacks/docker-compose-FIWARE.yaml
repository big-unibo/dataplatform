version: "3.9"
services:

  # Orion is the context broker
  orion:
    init: true
    image: fiware/orion:latest              # This variable `${ORION_VERSION}` is drawn from the `.env` file
    depends_on:
      - mongo-db                           # Create the `mongo-db` before this container
    networks:
      - BIG-dataplatform-network
    ports:
      - "8082:1026"  # Map a local port to a container's port (e.g., `IP:8082` to `IP:1026`)
    # Append this string to the final command that is executed by the container
    # Here, we are launching the OCB with: the possibility to perform "cors" requests, the name of the database, and the maximum payload parameter
    # You can also set the log level by adding `-logLevel DEBUG`
    command: -corsOrigin __ALL -dbhost mongo-db -inReqPayloadMaxSize 5000000
    deploy:
      placement:
        constraints:
          - node.hostname != CB-Mass-Node1


  # Database (orion + persistence)
  mongo-db:
    init: true
    image: mongo:latest
    ports:
      - "27017:27017" # 27017
    networks:
      - BIG-dataplatform-network
    volumes: # Specify that the `/data` folder **inside** the container is mapped to the volume `mongo-db`
      - mongodb_data:/data/db
    deploy:
      placement:
        constraints:
          - node.hostname != CB-Mass-Node1

volumes:
  mongodb_data:
    driver_opts:
      type: nfs
      o: addr=${NFSADDRESS},rw,nfsvers=4
      device: ":${NFSPATH}/dataplatform_config/mongodb_data/"

networks:
  BIG-dataplatform-network:
    external: true
    name: BIG-dataplatform-network